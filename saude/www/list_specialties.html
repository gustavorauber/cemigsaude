<div data-role="page" id="list-physicians-page" data-dom-cache="true">
    <div data-role="header" data-add-back-btn="true" data-back-btn-text="Voltar">
        <h2>Especialidades</h2>
        <a href="#" class="ui-btn ui-btn-right ui-btn-icon-right ui-icon-bars ui-shadow ui-corner-all">Menu</a>
    </div>
    <div role="content" class="ui-content">
        <form>
            <input type="text" data-type="search" id="specialty-input" />
            <input type="hidden" id="specialty" />
        </form>
        <br />
        <ul id="specialties" data-role="listview" data-autodividers="true" data-filter="true" data-input="#specialty-input">
        </ul>
    </div>
    <div class="menu" data-role="panel" data-position="right" data-display="overlay" data-theme="a">
        <ul data-role="listview">
            <li data-role="list-divider">Menu</li>
            <li data-icon="false"><a href="index.html" class="ui-btn ui-btn-icon-left ui-icon-home">&nbsp;</a></li>
            <li data-icon="false"><a href="map_search.html">Busca</a></li>
            <li data-icon="false"><a href="list_specialties.html">Listagem por Especialidade</a></li>
        </ul>
    </div>
    <div data-role="footer">
        <div style="text-align: center;"><img src="img/logo_cemig_saude.gif" /></div>
    </div>
    <script type="text/javascript">
    $('#' + $('div[data-role="page"]').last().attr('id')).on('pageinit',
      function(e, data) {
          var page_id = e.target.id;
          $('#' + page_id + ' .ui-icon-bars').on('click', function(e) {
              $('#' + page_id + ' .menu').panel('open');
          });

          $('#' + page_id ).on("swipeleft", function(e) {
        	  $('#' + page_id + ' .menu').panel('open');
          });
      }
    );
    </script>

    <div style="visibility: hidden; display: none;">
        <li id="specialty-clone">
            <a href="list_physicians_by_distance.html">
                <span class="specialty-title"></span>
                <span class="ui-li-count"></span>
            </a>
        </li>
    </div>

    <script type="text/javascript">
    $(document).bind("pagecreate", "#list-physicians-page", function() {
        $('FORM').on('submit', function(e) {
            e.preventDefault();
        });

        var updateURLParams = function (el) {
        	uri = $(el).attr('href');

    	    var reLat = new RegExp("([?&])lat=.*?(&|$)", "i");
    	    var reLon = new RegExp("([?&])lon=.*?(&|$)", "i");

    	    var separator = uri.indexOf('?') !== -1 ? "&" : "?";
    	    if (uri.match(reLat)) {
    	        uri = uri.replace(reLat, '$1lat=' + window.latitude + '$2');
    	    } else {
    	        uri = uri + separator + "lat=" + window.latitude;
    	    }


    	    if (uri.match(reLon)) {
                uri = uri.replace(reLon, '$1lon=' + window.longitude + '$2');
            } else {
                uri = uri + "&lon=" + window.longitude;
            }

    	    return uri;
    	};

        $.mobile.loading( 'show' , {theme: 'b', text: 'carregando...', textVisible: true});

        $.ajax({
            url: "https://fb.cemig.com.br/saude/api/list/",
            success: function(data) {
                parent = $('#specialties');
                $.each(data, function ( index, val ) {
                    dom = $('#specialty-clone').clone();
                    dom.attr('id', '');

                    if (val.specialty === "") {
                        dom.find('.specialty-title').html("MÃºltiplas Especialidades");
                    } else {
                        dom.find('.specialty-title').html(val.specialty);
                    }

                    dom.find('.ui-li-count').html(val.count);
                    dom.find('a').attr('hash', val.hash);

                    parent.append(dom);
                });

                $('#specialties').listview('refresh');

                window.latitude = -19.932696;
                window.longitude = -43.944035;

                $('#specialties a').attr('href', function (e) {
                    return updateURLParams($(this));
                });

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function (pos) {
                        window.latitude = pos.coords.latitude;
                        window.longitude = pos.coords.longitude;

                        $('#specialties a').attr('href', function (e) {
                    	    return updateURLParams($(this));
                        });
                    });
                }

                $.mobile.loading( 'hide' );
            },
            error: function(req, status, error) {
                $.mobile.loading( 'hide' );
                alert(error);
            }
        });
    });
    </script>
</div>