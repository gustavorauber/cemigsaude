{% extends "index.html" %}
{% load mobile_tags %}

{% block page_id %}physician-page{% endblock %}

{% block header %}
<h1>{{physician.get_name|title}}</h1>
{% endblock %}          

{% block content %}
<div class="ui-bar-c ui-corner-all ui-shadow" style="padding: 1em;" id="view-physician-page">
    <table data-role="table" data-mode="reflow" id="physician-data">
        <thead>
	        <tr>
	           <th>Especialidade(s)</th>
	           <th>Registro Profissional</th>
	           <th>Telefone</th>
	           {% if self.get_email %}
	               <th>E-Mail</th>
	           {% endif %}
	           <th>Endereço</th>
	        </tr>
	    </thead>
	    <tbody>
	        <tr>
	           <td>{{physician.get_specialty|title}}</td>
	           <td>{{physician.get_register}}</td>
	           <td>
	               {% if physician.get_phone|is_instance_of:"list" %}
		               {% for phone in physician.get_phone %}
		               <a href="tel:{{phone}}">{{phone}}</a>&nbsp;
		               {% endfor %}
		           {% else %} 
		           <a href="tel:{{physician.get_phone}}">{{physician.get_phone}}</a>
		           {% endif %}
	           </td>
	           {% if self.get_email %}
	               <td><a href="mailto:{{physician.get_email}}">{{physician.get_email}}</a></td>
	           {% endif %}
	           <td><a href="geo:{{physician.get_lat}},{{physician.get_lon}};u=35">{{physician.get_street_address|title}}, {{physician.get_neighborhood}}, {{physician.get_city|title}}</a></td>
	        </tr>
	    </tbody>
    </table>
</div>
<br />
<div class="ui-bar-c ui-corner-all ui-shadow" style="padding: 1em;">
    <div id="physician-map" style="height:400px;"></div>
</div>
<div id="directions">
</div>
{% endblock %}    

{% block javascript %}
<script type="text/javascript">
$(document).on("pageshow", "#physician-page", function(event) {
	
	var myLatlng = new google.maps.LatLng({{physician.get_lat}}, {{physician.get_lon}});
    var mapOptions = {
      zoom: 15,
      center: myLatlng
    };

    $('#directions').empty();
    $('#physician-map').empty();
    
    window.map = new google.maps.Map(document.getElementById('physician-map'), mapOptions);
    var bounds = new google.maps.LatLngBounds();
    var infoWindow = new google.maps.InfoWindow();

    var contentString = '<div>'+
        '<div id="siteNotice">'+
        '</div>'+
        '<h2 class="firstHeading">{{physician.get_name|title}}</h2>'+
        '<div>'+
        '<p><b>Especialidade(s)</b>: {{physician.get_specialty|title}} ' +
        '<p><b>Endereço</b>: {{physician.get_street_address|title}} ' +      
        '</div>'+
        '</div>';

    infoWindow.setContent(contentString);

    var marker = new google.maps.Marker({
        position: myLatlng,
        map: window.map,
        title: '{{physician.get_name|title}}'
    });

    bounds.extend(myLatlng);
    google.maps.event.addListener(marker, 'click', function() {
    	infoWindow.open(window.map, marker);
    });    
    
    google.maps.event.trigger(marker, 'click');
    //google.maps.event.trigger(window.map, 'resize');
    //window.map.setCenter(myLatlng);
    
    if (navigator.geolocation) { 
       navigator.geolocation.getCurrentPosition(function (position) {                                                              
           window.latitude = position.coords.latitude;                  
           window.longitude = position.coords.longitude;
           var coords = new google.maps.LatLng(window.latitude, window.longitude); 
           
           if (window.directionsDisplay == undefined) {
        	   window.directionsDisplay = new google.maps.DirectionsRenderer();   
           }
	    
           var directionsService = new google.maps.DirectionsService();
	    
           window.directionsDisplay.setMap(window.map);	    
           window.directionsDisplay.setPanel(document.getElementById("directions"));	    
	    
           var request = {
		      origin: coords,
		      destination: myLatlng,
		      travelMode: google.maps.TravelMode.DRIVING
		      // Note that Javascript allows us to access the constant
		      // using square brackets and a string value as its
		      // "property."
		      //travelMode: google.maps.TravelMode[selectedMode]		
           };
		
           directionsService.route(request, function(response, status) {		   
        	   if (status == google.maps.DirectionsStatus.OK) {		    	
        		   $('#directions').empty();		        
        		   window.directionsDisplay.setDirections(response);		    
        	   }		
           });		
       });
    }    
});
</script>    
{% endblock %}
