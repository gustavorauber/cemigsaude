<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">        
    <meta charset="utf-8">
    <title>Info windows</title>
    
    <link rel="stylesheet" href="/static/css/jquery.mobile-1.4.1.min.css" />
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
    
    <script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
    <script src="/static/js/jquery.mobile-1.4.1.min.js"></script>
  </head>
  <body>
    <div data-role="page">
        <div data-role="header">...</div>
        <div role="main" class="ui-content">
            <div class="ui-bar-c ui-corner-all ui-shadow" style="padding: 1em; padding-top: 0.1em;">
                <p>
                    <label for="search">Busca</label>
                    <input id="search" class="ui-bar-c" type="text" value="Dermatologia" />
                </p>
                <a id="submit" href="#" data-role="button" data-icon="search">Buscar conveniados</a>
                <div id="map-canvas" style="height:350px;"></div>
            </div>
        </div>
        <div data-role="footer">...</div>
    </div>
    
<script type="text/javascript">
function initialize() {
  var myLatlng = new google.maps.LatLng({{physician.get_lat}}, {{physician.get_lon}});
  var mapOptions = {
    zoom: 16,
    center: myLatlng
  };

  var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
  window.map = map;
  window.markers = [];

  var contentString = '<div>'+
      '<div id="siteNotice">'+
      '</div>'+
      '<h2 class="firstHeading">{{physician.get_name}}</h2>'+
      '<div>'+
      '<p><b>Especialidade(s)</b>: {{physician.get_specialty}} ' +
      '<p><b>Endereco</b>: {{physician.get_street_address}} ' +      
      '</div>'+
      '</div>';

  var infowindow = new google.maps.InfoWindow({
      content: contentString
  });

  var marker = new google.maps.Marker({
      position: myLatlng,
      map: map,
      title: 'Teste'
  });
  window.markers.push(marker);
  google.maps.event.addListener(marker, 'click', function() {
    infowindow.open(map,marker);
  });
}

google.maps.event.addDomListener(window, 'load', initialize);
</script>
<script type="text/javascript">
$(document).ready(function() {
	$('#submit').click(function(e) {
		$.post( "/search", { q: $('#search').val() }, function( data ) {
			for (var i = 0; i < window.markers.length; i++) {
			    markers[i].setMap(null);
			}
			window.markers = [];
		    $.each(data, function ( index, val ) {
			    //console.log(val);				    
			    for (i=0; i < val.addresses.length; i++) {				    	
			    	address = val.addresses[i];				    	
			    	if ( address.geocode != undefined ) {
			    		results = address.geocode.results;
			    		if (results.length > 0) {				    			
			    			result = results[0];
			    			l = result.geometry.location;
			    			marker = new google.maps.Marker({
			    				position: new google.maps.LatLng(l.lat, l.lng),
			    				map: window.map
			    			});
			    			marker.val = val;
			    			marker.address = address;
			    			google.maps.event.addListener(marker, 'click', 
			    				function() {
			    				  info = new google.maps.InfoWindow({
			    				      content: "<div>" + 
			    				      "<h3>"+ this.val.name +"</h3>" +
			    				      "<p><b>Tel</b>: " + this.address.phones + "</p>" +
			    				      "<p><b>Endere√ßo</b>: " + this.address.street + "</p>" +
			    				      "</div>"
			    				  });
			    				  info.open(window.map, this);
			    				  window.map.setCenter(this.getPosition());
			    			    }
			    			);
			    			window.markers.push(marker);
			    		}
			    		console.log(address);
			    	}
			    }
			});
		});
	});
});
</script>
    
  </body>
</html>