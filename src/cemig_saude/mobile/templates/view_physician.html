{% extends "index.html" %}

{% block header %}
<a href="/" data-icon="home">Início</a>
<h1>Busca</h1>
{% endblock %}          

{% block content %}
<div class="ui-bar-c ui-corner-all ui-shadow" style="padding: 1em;">
	<form id="form" action="#">
	    <input id="search" class="ui-bar-c" type="text" placeholder="Dermatologia" />                
	    <a id="submit" href="#" data-role="button" data-icon="search" data-corners="true" data-iconpos="right" data-inline="false">Buscar conveniados</a>
	    <div id="map-canvas" style="height:400px;"></div>
	</form>
</div>
{% endblock %}    

{% block javascript %}   
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script> 
<script type="text/javascript">
function initialize() {
  var myLatlng = new google.maps.LatLng({{physician.get_lat}}, {{physician.get_lon}});
  var mapOptions = {
    zoom: 15,
    center: myLatlng
  };

  var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
  window.map = map;
  window.markers = [];

  var contentString = '<div>'+
      '<div id="siteNotice">'+
      '</div>'+
      '<h2 class="firstHeading">{{physician.get_name}}</h2>'+
      '<div>'+
      '<p><b>Especialidade(s)</b>: {{physician.get_specialty}} ' +
      '<p><b>Endereco</b>: {{physician.get_street_address}} ' +      
      '</div>'+
      '</div>';

  var infowindow = new google.maps.InfoWindow({
      content: contentString
  });

  var marker = new google.maps.Marker({
      position: myLatlng,
      map: map,
      title: 'Teste'
  });
  window.markers.push(marker);
  google.maps.event.addListener(marker, 'click', function() {
    infowindow.open(map,marker);
  });
}

google.maps.event.addDomListener(window, 'load', initialize);
</script>
<script type="text/javascript">
$(document).ready(function() {
	
	window.infoWindow = new google.maps.InfoWindow;
	
	var onMarkerClick = function() {
		window.infoWindow.setContent(
			"<div>" + 
            "<h3>"+ this.val.name +"</h3>" +
            "<h4>"+ this.val.specialty +"</h4>" +
            "<p>" + 
                "<br /><b>Registro</b>: " + this.val.register +
	            "<br /><b>Tel</b>: " + this.address.phones +
	            "<br /><b>Endereço</b>: " + this.address.street +
	            "<br />" + this.address.neighborhood +
            "</p>" +
            "</div>"
        );
		window.infoWindow.open(window.map, this);
        window.map.setCenter(this.getPosition());
	};
	
	var performSearch = function(e) {
		e.preventDefault();
        $.post( "/search", { q: $('#search').val() }, function( data ) {
            for (var i = 0; i < window.markers.length; i++) {
                markers[i].setMap(null);
            }
            window.markers = [];
            $.each(data, function ( index, val ) {                
                for (i=0; i < val.addresses.length; i++) {                      
                    address = val.addresses[i];                     
                    if ( address.geocode != undefined ) {
                        results = address.geocode.results;
                        if (results.length > 0) {                               
                            result = results[0];
                            l = result.geometry.location;
                            marker = new google.maps.Marker({
                                position: new google.maps.LatLng(l.lat, l.lng),
                                map: window.map
                            });
                            marker.val = val;
                            marker.address = address;
                            google.maps.event.addListener(marker, 'click', 
                                onMarkerClick
                            );
                            window.markers.push(marker);
                        }
                        console.log(address);
                    }
                }
            });
        });
	};
	
	$('#submit').on({
		click: performSearch		
	});
	
	$('#form').on({        
        submit: performSearch
    });
});
</script>    
{% endblock %}
